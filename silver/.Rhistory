mutate(
auction_date = as.Date(auction_date, format='%d/%m/%Y'),
filling_date = as.Date(filling_date, format='%d/%m/%Y'),
regauged_date = as.Date(regauged_date, format='%d/%m/%Y'),
strength = as.numeric(strength),
bulk_litres = as.numeric(bulk_litres),
hammer_price = as.numeric(hammer_price)
)
df_whisky_hammer$rla <- NA
for (line in 1:nrow(df_whisky_hammer)){
if (is.na(df_whisky_hammer$rla[line]) & !is.na(df_whisky_hammer$bulk_litres[line]) & !is.na(df_whisky_hammer$strength[line])){
df_whisky_hammer$rla[line] = round(
df_whisky_hammer$strength[line]/100 * df_whisky_hammer$bulk_litres[line]
, 2)
}
else if (!is.na(df_whisky_hammer$rla[line]) & is.na(df_whisky_hammer$bulk_litres[line]) & !is.na(df_whisky_hammer$strength[line])){
df_whisky_hammer$bulk_litres[line] = round(
df_whisky_hammer$rla[line] / df_whisky_hammer$strength[line]/100
, 2)
}
else if (!is.na(df_whisky_hammer$rla[line]) & !is.na(df_whisky_hammer$bulk_litres[line]) & is.na(df_whisky_hammer$strength[line])){
df_whisky_hammer$strength[line] = round(
100 * df_whisky_hammer$rla[line] / df_whisky_hammer$bulk_litres[line]
, 2)
}
}
df_whisky_hammer$buyer_price <- round(1.125 * df_whisky_hammer$hammer_price, 2)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
auction_house = 'Whisky Hammer',
age = round(as.numeric((auction_date - filling_date) / 365.25), 2),
bottles_at_cask_strength = round(as.numeric(bulk_litres) / 0.7, 2),
hammer_price_per_bottle_at_cask_strength = round(hammer_price / bottles_at_cask_strength, 2),
hammer_price_per_litre_of_alcohol = round(hammer_price / rla, 2),
buyer_price = hammer_price * 0.1,
buyer_price_per_bottle_at_cask_strength = round(buyer_price / bottles_at_cask_strength, 2),
buyer_price_per_litre_of_alcohol = round(buyer_price / rla, 2),
)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
age = if_else(
age < 0,
0,
age
)
)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
distillery = if_else(
grepl('speyside', str_to_lower(title)),
'Speyside',
distillery
),
distillery = if_else(
grepl('lowland|secret ', str_to_lower(title)),
'Undisclosed Distillery',
distillery
)
)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
distillery_lower = str_to_lower(distillery)
)
df_whisky_hammer <- merge(df_whisky_hammer, df_distilleries_dim, by='distillery_lower', all.x = TRUE)
df_whisky_hammer$region <- case_when(str_detect(str_to_lower(df_whisky_hammer$title), "lowland") ~ 'Lowlands',
str_detect(str_to_lower(df_whisky_hammer$title), "highland") ~ "Highlands",
str_detect(df_whisky_hammer$distillery_lower, "whitlaw") ~ "Highlands",
str_detect(df_whisky_hammer$distillery_lower, "staoisha") ~ "Islay",
str_detect(df_whisky_hammer$distillery_lower, "rhinns") ~ "Islay",
str_detect(df_whisky_hammer$distillery_lower, "lochindaal") ~ "Islay",
str_detect(df_whisky_hammer$distillery_lower, "croftengea") ~ "Highlands",
str_detect(df_whisky_hammer$distillery_lower, "blue hill") ~ "Speyside",
str_detect(df_whisky_hammer$distillery_lower, "ledaig") ~ "Highlands",
str_detect(df_whisky_hammer$distillery_lower, "teithmill") ~ "Speyside",
str_detect(str_to_lower(df_whisky_hammer$distillery), "ledaig") ~ "Highlands",
str_detect(str_to_lower(df_whisky_hammer$distillery), "teithmill") ~ "Highlands",
TRUE ~ (df_whisky_hammer$region))
df_whisky_hammer <- df_whisky_hammer %>%
filter(title != 'Foursquare Barbados Rum - 2007 Barrel #92| Held In Bond')
df_whisky_hammer$country <- 'Scotland'
df_whisky_hammer$currency <- 'Great Britain Pound (£)'
df_whisky_hammer <- df_whisky_hammer %>%
select(
age, auction_date, auction_house, bottles_at_cask_strength, bulk_litres, buyer_price, buyer_price_per_bottle_at_cask_strength,
buyer_price_per_litre_of_alcohol, cask_filling, cask_type, country, currency, distillery, distillery_status, filling_date,
hammer_price, hammer_price_per_bottle_at_cask_strength, hammer_price_per_litre_of_alcohol, previous_spirit, regauged_date,
region, rla, sold, strength, title, url
)
df_whisky_hammer <- df_whisky_hammer %>%
filter(age > 0)
# Loads the rvest, stringr and dplyr libraries
suppressWarnings({
suppressPackageStartupMessages({
library(rvest)
library(stringr)
library(dplyr)
})
})
# Função para converter datas no formato dd/mm/yyyy
convert_to_date <- function(date_string) {
if (is.na(date_string)) {
return(NA) # Se for NA, retorna NA
}
date_complete <- tryCatch(
as.Date(date_string, format = "%d/%m/%Y"), # Formato para dia, mês e ano
error = function(e) NA
)
if (!is.na(date_complete)) {
return(format(date_complete, "%d/%m/%Y")) # Retorna no formato dd/mm/yyyy
}
# Primeiro tenta converter para datas completas no formato dd/mm/yyyy
date_complete <- tryCatch(
as.Date(date_string, format = "%d %B %Y"), # Formato para dia, mês e ano
error = function(e) NA
)
if (!is.na(date_complete)) {
return(format(date_complete, "%d/%m/%Y")) # Retorna no formato dd/mm/yyyy
}
# Tenta lidar com strings apenas com mês e ano
date_complete <- tryCatch(
as.Date(paste0("01 ", date_string), format = "%d %B %Y"),
error = function(e) NA
)
if (!is.na(date_complete)) {
return(format(date_complete, "%d/%m/%Y"))
}
# Tenta lidar com strings que possuem apenas o ano
date_complete <- tryCatch(
as.Date(paste0("01/01/", date_string), format = "%d/%m/%Y"),
error = function(e) NA
)
if (!is.na(date_complete)) {
return(format(date_complete, "%d/%m/%Y")) # Retorna no formato dd/mm/yyyy
}
return(NA) # Retorna NA se não conseguir converter
}
# Language: us-english
Sys.setlocale("LC_ALL", "en_US.UTF-8")
setwd("C:\\Users\\joaov\\Documents\\Whisky Casks ETL\\bronze")
df_whisky_hammer <- read.csv2("Whisky Hammer - Casks Database.csv", sep=';')
df_whisky_hammer_image_analysis <- read.csv2("Whisky Hammer - Images Analysis.csv", sep=';')
setwd("C:\\Users\\joaov\\Documents\\Whisky Casks ETL\\dim_distilleries_info")
df_distilleries_dim <- read.csv2("dim_distilleries_info.csv", sep=';')
df_distilleries_dim <- df_distilleries_dim %>%
select(Distillery, Region, Is.Closed)
df_distilleries_dim <- df_distilleries_dim %>%
rename(
distillery = Distillery,
region = Region,
is_closed= Is.Closed
)
df_distilleries_dim <- df_distilleries_dim %>%
mutate(
distillery_lower = str_to_lower(distillery),
)
df_distilleries_dim <- df_distilleries_dim %>%
mutate(
distillery_status = if_else(
is_closed == 'True',
'Closed',
'Operational'
)
)
df_distilleries_dim <- df_distilleries_dim %>% select(-distillery, -is_closed)
df_whisky_hammer <- df_whisky_hammer %>% left_join(df_whisky_hammer_image_analysis, by='image')
df_whisky_hammer$bulk_litres <- df_whisky_hammer$bulk_litres %>% str_replace('L', '') %>% trimws()
df_whisky_hammer$strength <- df_whisky_hammer$strength %>% str_replace('%|ABV', '') %>% str_replace('ABV', '') %>% trimws()
df_whisky_hammer$regauged_date <- df_whisky_hammer$regauged_date %>% str_replace("(?i)(\\d+)(st|nd|rd|th)", '')
df_whisky_hammer$filling_year <- as.character(df_whisky_hammer$filling_year)
df_whisky_hammer$regauged_date <- unlist(lapply(df_whisky_hammer$regauged_date, convert_to_date))
df_whisky_hammer$filling_date <- unlist(lapply(df_whisky_hammer$filling_year, convert_to_date))
df_whisky_hammer$auction_date <- unlist(lapply(df_whisky_hammer$auction_date, convert_to_date))
df_whisky_hammer$distillery <- df_whisky_hammer$distillery %>% str_replace('(?i)distillery', '') %>% str_replace('(?i)distillers', '') %>% str_replace('(?i)the ', '') %>% str_replace('(?i)isle of', '') %>% trimws()
df_whisky_hammer$distillery <- case_when(str_detect(str_to_lower(df_whisky_hammer$distillery), "brewdog") ~ "Brewdog",
str_detect(str_to_lower(df_whisky_hammer$distillery), "aultmore") ~ 'Aultmore',
str_detect(str_to_lower(df_whisky_hammer$distillery), "whitlaw") ~ "Whitlaw (Highland Park)",
str_detect(str_to_lower(df_whisky_hammer$distillery), "foursquare") ~ "Foursquare",
str_detect(str_to_lower(df_whisky_hammer$distillery), "staoisha") ~ "Staoisha (Bunnahabhain)",
str_detect(str_to_lower(df_whisky_hammer$distillery), "rhinns") ~ "Rhinns (Bruichladdich)",
str_detect(str_to_lower(df_whisky_hammer$distillery), "lochindaal") ~ "Lochindaal (Bruichladdich)",
str_detect(str_to_lower(df_whisky_hammer$distillery), "croftengea") ~ "Croftengea (Loch Lomond)",
str_detect(str_to_lower(df_whisky_hammer$distillery), "ledaig") ~ "Ledaig (Tobermory)",
str_detect(str_to_lower(df_whisky_hammer$distillery), "teithmill") ~ "teithmill (Deanston)",
TRUE ~ (df_whisky_hammer$distillery))
title_cask_type <- str_to_lower(
paste0(df_whisky_hammer$cask_type, ' - ', df_whisky_hammer$title)
)
df_whisky_hammer$cask_filling <- case_when(str_detect(title_cask_type, "1st|first|fresh") ~ "First Fill",
str_detect(title_cask_type, "2nd|second|refill") ~ "Second Fill",
str_detect(title_cask_type, "3rd|third") ~ "Third Fill",
str_detect(title_cask_type, "virgin|new") ~ "Virgin Oak",
TRUE ~ NA)
df_whisky_hammer$previous_spirit <- case_when(str_detect(title_cask_type, "sherry|oloroso|px|pedro ximenez|amontillado|palo cortado") ~ "Sherry",
str_detect(title_cask_type, "jack daniel's|heaven hill|bourbon") ~ "Bourbon",
str_detect(title_cask_type, "rum|diamond rum|caroni") ~ "Rum",
str_detect(title_cask_type, "laphroaig") ~ "Scotch Whisky",
str_detect(title_cask_type, "madeira") ~ "Madeira",
str_detect(title_cask_type, "port") ~ "Port",
str_detect(title_cask_type, "vin santo|vino santo|mosctael|muscat|moscatel|pineau|climens|guthrie|rivesaltes|wine") ~ "Wine",
str_detect(title_cask_type, "virgin") ~ "Virgin ak",
TRUE ~ NA)
df_whisky_hammer$cask_type <- case_when(str_detect(title_cask_type, "hogshead") ~ "Hogshead",
str_detect(title_cask_type, "barrel") ~ "Barrel",
str_detect(title_cask_type, "butt") ~ "Butt",
str_detect(title_cask_type, "quarter cask") ~ "Quarter Cask",
str_detect(title_cask_type, "barrique") ~ "Barrique",
str_detect(title_cask_type, "octave") ~ "Octave",
TRUE ~ NA)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
auction_date = as.Date(auction_date, format='%d/%m/%Y'),
filling_date = as.Date(filling_date, format='%d/%m/%Y'),
regauged_date = as.Date(regauged_date, format='%d/%m/%Y'),
strength = as.numeric(strength),
bulk_litres = as.numeric(bulk_litres),
hammer_price = as.numeric(hammer_price)
)
df_whisky_hammer$rla <- NA
for (line in 1:nrow(df_whisky_hammer)){
if (is.na(df_whisky_hammer$rla[line]) & !is.na(df_whisky_hammer$bulk_litres[line]) & !is.na(df_whisky_hammer$strength[line])){
df_whisky_hammer$rla[line] = round(
df_whisky_hammer$strength[line]/100 * df_whisky_hammer$bulk_litres[line]
, 2)
}
else if (!is.na(df_whisky_hammer$rla[line]) & is.na(df_whisky_hammer$bulk_litres[line]) & !is.na(df_whisky_hammer$strength[line])){
df_whisky_hammer$bulk_litres[line] = round(
df_whisky_hammer$rla[line] / df_whisky_hammer$strength[line]/100
, 2)
}
else if (!is.na(df_whisky_hammer$rla[line]) & !is.na(df_whisky_hammer$bulk_litres[line]) & is.na(df_whisky_hammer$strength[line])){
df_whisky_hammer$strength[line] = round(
100 * df_whisky_hammer$rla[line] / df_whisky_hammer$bulk_litres[line]
, 2)
}
}
df_whisky_hammer$buyer_price <- round(1.125 * df_whisky_hammer$hammer_price, 2)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
auction_house = 'Whisky Hammer',
age = round(as.numeric((auction_date - filling_date) / 365.25), 2),
bottles_at_cask_strength = round(as.numeric(bulk_litres) / 0.7, 2),
hammer_price_per_bottle_at_cask_strength = round(hammer_price / bottles_at_cask_strength, 2),
hammer_price_per_litre_of_alcohol = round(hammer_price / rla, 2),
buyer_price = hammer_price * 0.1,
buyer_price_per_bottle_at_cask_strength = round(buyer_price / bottles_at_cask_strength, 2),
buyer_price_per_litre_of_alcohol = round(buyer_price / rla, 2),
)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
age = if_else(
age < 0,
0,
age
)
)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
distillery = if_else(
grepl('speyside', str_to_lower(title)),
'Speyside',
distillery
),
distillery = if_else(
grepl('lowland|secret ', str_to_lower(title)),
'Undisclosed Distillery',
distillery
)
)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
distillery_lower = str_to_lower(distillery)
)
df_whisky_hammer <- merge(df_whisky_hammer, df_distilleries_dim, by='distillery_lower', all.x = TRUE)
df_whisky_hammer$region <- case_when(str_detect(str_to_lower(df_whisky_hammer$title), "lowland") ~ 'Lowlands',
str_detect(str_to_lower(df_whisky_hammer$title), "highland") ~ "Highlands",
str_detect(df_whisky_hammer$distillery_lower, "whitlaw") ~ "Highlands",
str_detect(df_whisky_hammer$distillery_lower, "staoisha") ~ "Islay",
str_detect(df_whisky_hammer$distillery_lower, "rhinns") ~ "Islay",
str_detect(df_whisky_hammer$distillery_lower, "lochindaal") ~ "Islay",
str_detect(df_whisky_hammer$distillery_lower, "croftengea") ~ "Highlands",
str_detect(df_whisky_hammer$distillery_lower, "blue hill") ~ "Speyside",
str_detect(df_whisky_hammer$distillery_lower, "ledaig") ~ "Highlands",
str_detect(df_whisky_hammer$distillery_lower, "teithmill") ~ "Speyside",
str_detect(str_to_lower(df_whisky_hammer$distillery), "ledaig") ~ "Highlands",
str_detect(str_to_lower(df_whisky_hammer$distillery), "teithmill") ~ "Highlands",
TRUE ~ (df_whisky_hammer$region))
df_whisky_hammer <- df_whisky_hammer %>%
filter(title != 'Foursquare Barbados Rum - 2007 Barrel #92| Held In Bond')
df_whisky_hammer <- df_whisky_hammer %>%
filter(age > 0)
df_whisky_hammer$country <- 'Scotland'
df_whisky_hammer$currency <- 'Great Britain Pound (£)'
df_whisky_hammer <- df_whisky_hammer %>%
select(
age, auction_date, auction_house, bottles_at_cask_strength, bulk_litres, buyer_price, buyer_price_per_bottle_at_cask_strength,
buyer_price_per_litre_of_alcohol, cask_filling, cask_type, country, currency, distillery, distillery_status, filling_date,
hammer_price, hammer_price_per_bottle_at_cask_strength, hammer_price_per_litre_of_alcohol, previous_spirit, regauged_date,
region, rla, sold, strength, title, url
)
setwd("C:\\Users\\joaov\\Documents\\Whisky Casks ETL\\silver")
write.csv(df_whisky_hammer, file = "whisky_hammer", row.names = FALSE, fileEncoding = "UTF-8")
# Loads the rvest, stringr and dplyr libraries
suppressWarnings({
suppressPackageStartupMessages({
library(rvest)
library(stringr)
library(dplyr)
})
})
# Função para converter datas no formato dd/mm/yyyy
convert_to_date <- function(date_string) {
if (is.na(date_string)) {
return(NA) # Se for NA, retorna NA
}
date_complete <- tryCatch(
as.Date(date_string, format = "%d/%m/%Y"), # Formato para dia, mês e ano
error = function(e) NA
)
if (!is.na(date_complete)) {
return(format(date_complete, "%d/%m/%Y")) # Retorna no formato dd/mm/yyyy
}
# Primeiro tenta converter para datas completas no formato dd/mm/yyyy
date_complete <- tryCatch(
as.Date(date_string, format = "%d %B %Y"), # Formato para dia, mês e ano
error = function(e) NA
)
if (!is.na(date_complete)) {
return(format(date_complete, "%d/%m/%Y")) # Retorna no formato dd/mm/yyyy
}
# Tenta lidar com strings apenas com mês e ano
date_complete <- tryCatch(
as.Date(paste0("01 ", date_string), format = "%d %B %Y"),
error = function(e) NA
)
if (!is.na(date_complete)) {
return(format(date_complete, "%d/%m/%Y"))
}
# Tenta lidar com strings que possuem apenas o ano
date_complete <- tryCatch(
as.Date(paste0("01/01/", date_string), format = "%d/%m/%Y"),
error = function(e) NA
)
if (!is.na(date_complete)) {
return(format(date_complete, "%d/%m/%Y")) # Retorna no formato dd/mm/yyyy
}
return(NA) # Retorna NA se não conseguir converter
}
# Language: us-english
Sys.setlocale("LC_ALL", "en_US.UTF-8")
setwd("C:\\Users\\joaov\\Documents\\Whisky Casks ETL\\bronze")
df_whisky_hammer <- read.csv2("Whisky Hammer - Casks Database.csv", sep=';')
df_whisky_hammer_image_analysis <- read.csv2("Whisky Hammer - Images Analysis.csv", sep=';')
setwd("C:\\Users\\joaov\\Documents\\Whisky Casks ETL\\dim_distilleries_info")
df_distilleries_dim <- read.csv2("dim_distilleries_info.csv", sep=';')
df_distilleries_dim <- df_distilleries_dim %>%
select(Distillery, Region, Is.Closed)
df_distilleries_dim <- df_distilleries_dim %>%
rename(
distillery = Distillery,
region = Region,
is_closed= Is.Closed
)
df_distilleries_dim <- df_distilleries_dim %>%
mutate(
distillery_lower = str_to_lower(distillery),
)
df_distilleries_dim <- df_distilleries_dim %>%
mutate(
distillery_status = if_else(
is_closed == 'True',
'Closed',
'Operational'
)
)
df_distilleries_dim <- df_distilleries_dim %>% select(-distillery, -is_closed)
df_whisky_hammer <- df_whisky_hammer %>% left_join(df_whisky_hammer_image_analysis, by='image')
df_whisky_hammer$bulk_litres <- df_whisky_hammer$bulk_litres %>% str_replace('L', '') %>% trimws()
df_whisky_hammer$strength <- df_whisky_hammer$strength %>% str_replace('%|ABV', '') %>% str_replace('ABV', '') %>% trimws()
df_whisky_hammer$regauged_date <- df_whisky_hammer$regauged_date %>% str_replace("(?i)(\\d+)(st|nd|rd|th)", '')
df_whisky_hammer$filling_year <- as.character(df_whisky_hammer$filling_year)
df_whisky_hammer$regauged_date <- unlist(lapply(df_whisky_hammer$regauged_date, convert_to_date))
df_whisky_hammer$filling_date <- unlist(lapply(df_whisky_hammer$filling_year, convert_to_date))
df_whisky_hammer$auction_date <- unlist(lapply(df_whisky_hammer$auction_date, convert_to_date))
df_whisky_hammer$distillery <- df_whisky_hammer$distillery %>% str_replace('(?i)distillery', '') %>% str_replace('(?i)distillers', '') %>% str_replace('(?i)the ', '') %>% str_replace('(?i)isle of', '') %>% trimws()
df_whisky_hammer$distillery <- case_when(str_detect(str_to_lower(df_whisky_hammer$distillery), "brewdog") ~ "Brewdog",
str_detect(str_to_lower(df_whisky_hammer$distillery), "aultmore") ~ 'Aultmore',
str_detect(str_to_lower(df_whisky_hammer$distillery), "whitlaw") ~ "Whitlaw (Highland Park)",
str_detect(str_to_lower(df_whisky_hammer$distillery), "foursquare") ~ "Foursquare",
str_detect(str_to_lower(df_whisky_hammer$distillery), "staoisha") ~ "Staoisha (Bunnahabhain)",
str_detect(str_to_lower(df_whisky_hammer$distillery), "rhinns") ~ "Rhinns (Bruichladdich)",
str_detect(str_to_lower(df_whisky_hammer$distillery), "lochindaal") ~ "Lochindaal (Bruichladdich)",
str_detect(str_to_lower(df_whisky_hammer$distillery), "croftengea") ~ "Croftengea (Loch Lomond)",
str_detect(str_to_lower(df_whisky_hammer$distillery), "ledaig") ~ "Ledaig (Tobermory)",
str_detect(str_to_lower(df_whisky_hammer$distillery), "teithmill") ~ "teithmill (Deanston)",
TRUE ~ (df_whisky_hammer$distillery))
title_cask_type <- str_to_lower(
paste0(df_whisky_hammer$cask_type, ' - ', df_whisky_hammer$title)
)
df_whisky_hammer$cask_filling <- case_when(str_detect(title_cask_type, "1st|first|fresh") ~ "First Fill",
str_detect(title_cask_type, "2nd|second|refill") ~ "Second Fill",
str_detect(title_cask_type, "3rd|third") ~ "Third Fill",
str_detect(title_cask_type, "virgin|new") ~ "Virgin Oak",
TRUE ~ NA)
df_whisky_hammer$previous_spirit <- case_when(str_detect(title_cask_type, "sherry|oloroso|px|pedro ximenez|amontillado|palo cortado") ~ "Sherry",
str_detect(title_cask_type, "jack daniel's|heaven hill|bourbon") ~ "Bourbon",
str_detect(title_cask_type, "rum|diamond rum|caroni") ~ "Rum",
str_detect(title_cask_type, "laphroaig") ~ "Scotch Whisky",
str_detect(title_cask_type, "madeira") ~ "Madeira",
str_detect(title_cask_type, "port") ~ "Port",
str_detect(title_cask_type, "vin santo|vino santo|mosctael|muscat|moscatel|pineau|climens|guthrie|rivesaltes|wine") ~ "Wine",
str_detect(title_cask_type, "virgin") ~ "Virgin ak",
TRUE ~ NA)
df_whisky_hammer$cask_type <- case_when(str_detect(title_cask_type, "hogshead") ~ "Hogshead",
str_detect(title_cask_type, "barrel") ~ "Barrel",
str_detect(title_cask_type, "butt") ~ "Butt",
str_detect(title_cask_type, "quarter cask") ~ "Quarter Cask",
str_detect(title_cask_type, "barrique") ~ "Barrique",
str_detect(title_cask_type, "octave") ~ "Octave",
TRUE ~ NA)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
auction_date = as.Date(auction_date, format='%d/%m/%Y'),
filling_date = as.Date(filling_date, format='%d/%m/%Y'),
regauged_date = as.Date(regauged_date, format='%d/%m/%Y'),
strength = as.numeric(strength),
bulk_litres = as.numeric(bulk_litres),
hammer_price = as.numeric(hammer_price)
)
df_whisky_hammer$rla <- NA
for (line in 1:nrow(df_whisky_hammer)){
if (is.na(df_whisky_hammer$rla[line]) & !is.na(df_whisky_hammer$bulk_litres[line]) & !is.na(df_whisky_hammer$strength[line])){
df_whisky_hammer$rla[line] = round(
df_whisky_hammer$strength[line]/100 * df_whisky_hammer$bulk_litres[line]
, 2)
}
else if (!is.na(df_whisky_hammer$rla[line]) & is.na(df_whisky_hammer$bulk_litres[line]) & !is.na(df_whisky_hammer$strength[line])){
df_whisky_hammer$bulk_litres[line] = round(
df_whisky_hammer$rla[line] / df_whisky_hammer$strength[line]/100
, 2)
}
else if (!is.na(df_whisky_hammer$rla[line]) & !is.na(df_whisky_hammer$bulk_litres[line]) & is.na(df_whisky_hammer$strength[line])){
df_whisky_hammer$strength[line] = round(
100 * df_whisky_hammer$rla[line] / df_whisky_hammer$bulk_litres[line]
, 2)
}
}
df_whisky_hammer$buyer_price <- round(1.125 * df_whisky_hammer$hammer_price, 2)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
auction_house = 'Whisky Hammer',
age = round(as.numeric((auction_date - filling_date) / 365.25), 2),
bottles_at_cask_strength = round(as.numeric(bulk_litres) / 0.7, 2),
hammer_price_per_bottle_at_cask_strength = round(hammer_price / bottles_at_cask_strength, 2),
hammer_price_per_litre_of_alcohol = round(hammer_price / rla, 2),
buyer_price = hammer_price * 0.1,
buyer_price_per_bottle_at_cask_strength = round(buyer_price / bottles_at_cask_strength, 2),
buyer_price_per_litre_of_alcohol = round(buyer_price / rla, 2),
)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
age = if_else(
age < 0,
0,
age
)
)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
distillery = if_else(
grepl('speyside', str_to_lower(title)),
'Speyside',
distillery
),
distillery = if_else(
grepl('lowland|secret ', str_to_lower(title)),
'Undisclosed Distillery',
distillery
)
)
df_whisky_hammer <- df_whisky_hammer %>%
mutate(
distillery_lower = str_to_lower(distillery)
)
df_whisky_hammer <- merge(df_whisky_hammer, df_distilleries_dim, by='distillery_lower', all.x = TRUE)
df_whisky_hammer$region <- case_when(str_detect(str_to_lower(df_whisky_hammer$title), "lowland") ~ 'Lowlands',
str_detect(str_to_lower(df_whisky_hammer$title), "highland") ~ "Highlands",
str_detect(df_whisky_hammer$distillery_lower, "whitlaw") ~ "Highlands",
str_detect(df_whisky_hammer$distillery_lower, "staoisha") ~ "Islay",
str_detect(df_whisky_hammer$distillery_lower, "rhinns") ~ "Islay",
str_detect(df_whisky_hammer$distillery_lower, "lochindaal") ~ "Islay",
str_detect(df_whisky_hammer$distillery_lower, "croftengea") ~ "Highlands",
str_detect(df_whisky_hammer$distillery_lower, "blue hill") ~ "Speyside",
str_detect(df_whisky_hammer$distillery_lower, "ledaig") ~ "Highlands",
str_detect(df_whisky_hammer$distillery_lower, "teithmill") ~ "Speyside",
str_detect(str_to_lower(df_whisky_hammer$distillery), "ledaig") ~ "Highlands",
str_detect(str_to_lower(df_whisky_hammer$distillery), "teithmill") ~ "Highlands",
TRUE ~ (df_whisky_hammer$region))
df_whisky_hammer <- df_whisky_hammer %>%
filter(title != 'Foursquare Barbados Rum - 2007 Barrel #92| Held In Bond')
df_whisky_hammer <- df_whisky_hammer %>%
filter(age > 0)
df_whisky_hammer$country <- 'Scotland'
df_whisky_hammer$currency <- 'Great Britain Pound (£)'
df_whisky_hammer <- df_whisky_hammer %>%
select(
age, auction_date, auction_house, bottles_at_cask_strength, bulk_litres, buyer_price, buyer_price_per_bottle_at_cask_strength,
buyer_price_per_litre_of_alcohol, cask_filling, cask_type, country, currency, distillery, distillery_status, filling_date,
hammer_price, hammer_price_per_bottle_at_cask_strength, hammer_price_per_litre_of_alcohol, previous_spirit, regauged_date,
region, rla, sold, strength, title, url
)
setwd("C:\\Users\\joaov\\Documents\\Whisky Casks ETL\\silver")
write.csv(df_whisky_hammer, file = "whisky_hammer.csv", row.names = FALSE, fileEncoding = "UTF-8")
