second_page <- read_html(lots_data$link[j])
# Extracts lot informations from second page
lot_infos <- second_page %>% html_nodes('#view-all-lots')
# Extracts lot ID
id <- lot_infos %>% html_nodes('span.product_main_iot_44') %>% html_text() %>% strsplit(':') %>% unlist() %>% .[2] %>% str_trim()
lots_data[['id']][j] <- id
# Extracts lot status
status <- lot_infos %>% html_nodes('span.auction-highlight__bid-label') %>% html_text()
lots_data[['status']][j] <- status
sold <- ifelse(status=='Winning Bid', TRUE, FALSE)
lots_data[['sold']][j] <- sold
# Extracts end date
end_date <- lot_infos %>% html_nodes('#product-div') %>% html_nodes('span') %>% keep(~ str_detect(html_text(.), "End Date:")) %>% html_text() %>% str_split(':') %>% unlist() %>% .[2] %>% dmy(.)
lots_data[['end_date']][j] <- end_date
# Extracts lot description and details section
description_detais <- second_page %>% html_nodes('#description-details')
# Extracts lot description
description <- description_detais %>% html_nodes('div.first-para') %>% html_nodes('p') %>% html_text() %>% str_trim() %>% str_replace_all(., '\r\n', ' ') %>% paste(., collapse = " ") %>% str_trim()
lots_data[['description']][j] <- description
# Extracts lot details
details <- description_detais %>% html_nodes('ul') %>% html_text() %>% str_split(., "\n\n|\n") %>% unlist(.) %>% str_trim()
for (detail in details){
if (str_detect(str_to_title(detail), 'Originally Filled')) {
lots_data[['filling_date']][j] <- str_to_title(detail)
}
if (str_detect(str_to_title(detail), 'Cask No|Cask Number')) {
lots_data[['cask_number']][j] <- str_to_title(detail)
}
if (str_detect(str_to_title(detail), 'Distillery')) {
lots_data[['distillery']][j] <- str_to_title(detail)
}
if (str_detect(str_to_title(detail), 'Distilled')) {
lots_data[['year_distilled']][j] <- str_to_title(detail)
}
if (str_detect(str_to_title(detail), 'Age')) {
lots_data[['age']][j] <- str_to_title(detail)
}
if (str_detect(str_to_title(detail), 'Cask') & str_detect(str_to_title(detail), 'Type')) {
lots_data[['cask_type']][j] <- str_to_title(detail)
}
if (str_detect(str_to_title(detail), 'Original') & str_detect(str_to_title(detail), 'Alcohol|Strength')) {
lots_data[['original_litres_alcohol']][j] <- str_to_title(detail)
}
if (str_detect(str_to_title(detail), 'Original') & str_detect(str_to_title(detail), 'Bulk')) {
lots_data[['original_bulk_litres']][j] <- str_to_title(detail)
}
if (str_detect(str_to_title(detail), 'Re-Gauged') & str_detect(str_to_title(detail), 'Alcohol|Strength')) {
lots_data[['regauged_litres_alcohol']][j] <- str_to_title(detail)
}
if (str_detect(str_to_title(detail), 'Re-Gauged') & str_detect(str_to_title(detail), 'Bulk')) {
lots_data[['regauged_bulk_litres']][j] <- str_to_title(detail)
}
if (str_detect(str_to_title(detail), 'Strength')) {
lots_data[['strength']][j] <- str_to_title(detail)
}
}
}
# Exports the RDS file
write.csv2(lots_data, file = 'Whisky Online Auctions - Database.csv', row.names = FALSE)
# Import necessary libraries
suppressWarnings({
suppressPackageStartupMessages({
library(dplyr)
library(rvest)
library(stringr)
library(glue)
})
})
# Language: us-english
Sys.setlocale("LC_ALL", "en_US.UTF-8")
setwd('C:\\Users\\joaov\\Documents\\Whisky Casks ETL')
# Defines the The Grand whisky Auctions URL
url <- "https://www.thegrandwhiskyauction.com/past-auctions/cask/180-per-page"
# Scrape the auction data
casks_data <-
# Read HTML content from the specified URL
read_html(url) %>%
# Extract the script element containing auction data using XPath 'auction_data ='
html_element(xpath = "//script[contains(text(),'auction_data = ')]") %>%
# Extract text content from the script element
html_text() %>%
# Clean up the JavaScript to make it parsable as JSON
str_extract("\\[.*\\]") %>%
# Convert the JSON-like string into a JSON list
jsonlite::fromJSON()
# Import necessary libraries
suppressWarnings({
suppressPackageStartupMessages({
library(dplyr)
library(rvest)
library(stringr)
library(glue)
library(httr2)
})
})
# Language: us-english
Sys.setlocale("LC_ALL", "en_US.UTF-8")
setwd('C:\\Users\\joaov\\Documents\\Whisky Casks ETL')
# Defines the The Grand whisky Auctions URL
url <- "https://www.thegrandwhiskyauction.com/past-auctions/cask/180-per-page"
# Scrape the auction data
casks_data <-
resp <- request(url) %>%
req_user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64)
AppleWebKit/537.36 (KHTML, like Gecko)
Chrome/120.0.0.0 Safari/537.36") %>%
req_perform()
# Import necessary libraries
suppressWarnings({
suppressPackageStartupMessages({
library(dplyr)
library(rvest)
library(stringr)
library(glue)
library(chromote)
})
})
# Language: us-english
Sys.setlocale("LC_ALL", "en_US.UTF-8")
setwd('C:\\Users\\joaov\\Documents\\Whisky Casks ETL')
# Defines the The Grand whisky Auctions URL
url <- "https://www.thegrandwhiskyauction.com/past-auctions/cask/180-per-page"
b <- ChromoteSession$new()
b$Page$navigate(url)
b$Page$loadEventFired()  # espera o carregamento
# pegar HTML renderizado
html <- b$DOM$getDocument() %>%
b$DOM$getOuterHTML(nodeId = .$root$nodeId) %>%
.$outerHTML %>%
read_html()
b$DOM$getDocument() %>%
b$DOM$getOuterHTML(nodeId = .$root$nodeId) %>%
.$outerHTML %>%
read_html()
# Import necessary libraries
suppressWarnings({
suppressPackageStartupMessages({
library(dplyr)
library(rvest)
library(stringr)
library(glue)
library(chromote)
})
})
# Language: us-english
Sys.setlocale("LC_ALL", "en_US.UTF-8")
setwd('C:\\Users\\joaov\\Documents\\Whisky Casks ETL')
# Defines the The Grand whisky Auctions URL
url <- "https://www.thegrandwhiskyauction.com/past-auctions/cask/180-per-page"
b <- ChromoteSession$new()
b$Page$navigate(url)
b$Page$loadEventFired()   # espera o carregamento
# pegar o documento raiz
doc <- b$DOM$getDocument()
# extrair o HTML completo
html <- b$DOM$getOuterHTML(nodeId = doc$root$nodeId)$outerHTML %>%
read_html()
html
# Scrape the auction data
casks_data <-
html %>%
# Extract the script element containing auction data using XPath 'auction_data ='
html_element(xpath = "//script[contains(text(),'auction_data = ')]") %>%
# Extract text content from the script element
html_text() %>%
# Clean up the JavaScript to make it parsable as JSON
str_extract("\\[.*\\]") %>%
# Convert the JSON-like string into a JSON list
jsonlite::fromJSON()
html %>%
# Extract the script element containing auction data using XPath 'auction_data ='
html_element(xpath = "//script[contains(text(),'auction_data = ')]")
html
View(html)
html[2]
html
# Import necessary libraries
suppressWarnings({
suppressPackageStartupMessages({
library(dplyr)
library(rvest)
library(stringr)
library(glue)
library(chromote)
})
})
# Language: us-english
Sys.setlocale("LC_ALL", "en_US.UTF-8")
setwd('C:\\Users\\joaov\\Documents\\Whisky Casks ETL')
# Defines the The Grand whisky Auctions URL
url <- "https://www.thegrandwhiskyauction.com/past-auctions/cask/180-per-page"
b <- ChromoteSession$new()
b$view()  # abre uma aba real do Chrome controlada pelo chromote
b$Page$navigate(url)
# espera uns segundos para o Cloudflare liberar (ou ajuste conforme sua internet)
Sys.sleep(10)
# pega o documento raiz depois que a página terminou de carregar
doc <- b$DOM$getDocument()
# extrai o HTML real
html <- b$DOM$getOuterHTML(nodeId = doc$root$nodeId)$outerHTML %>%
read_html()
# Import necessary libraries
suppressWarnings({
suppressPackageStartupMessages({
library(dplyr)
library(rvest)
library(stringr)
library(glue)
library(chromote)
library(RSelenium)
})
})
# Language: us-english
Sys.setlocale("LC_ALL", "en_US.UTF-8")
setwd('C:\\Users\\joaov\\Documents\\Whisky Casks ETL')
# Defines the The Grand whisky Auctions URL
url <- "https://www.thegrandwhiskyauction.com/past-auctions/cask/180-per-page"
# Inicia o Selenium (precisa do docker rodando selenium/standalone-chrome)
rD <- rsDriver(browser = "chrome", port = 4545L, chromever = "latest")
# Import necessary libraries
suppressWarnings({
suppressPackageStartupMessages({
library(dplyr)
library(rvest)
library(stringr)
library(glue)
library(chromote)
library(RSelenium)
})
})
# Language: us-english
Sys.setlocale("LC_ALL", "en_US.UTF-8")
setwd('C:\\Users\\joaov\\Documents\\Whisky Casks ETL')
# Defines the The Grand whisky Auctions URL
url <- "https://www.thegrandwhiskyauction.com/past-auctions/cask/180-per-page"
# Inicia o Selenium (precisa do docker rodando selenium/standalone-chrome)
rD <- rsDriver(browser = "chrome", chromever = "latest",
port = 4545L, check = FALSE)
remDr <- rD$client
# Abre a página
remDr$navigate(url)
# Import necessary libraries
suppressWarnings({
suppressPackageStartupMessages({
library(dplyr)
library(rvest)
library(stringr)
library(glue)
library(chromote)
})
})
# Language: us-english
Sys.setlocale("LC_ALL", "en_US.UTF-8")
setwd('C:\\Users\\joaov\\Documents\\Whisky Casks ETL')
# Defines the The Grand whisky Auctions URL
url <- "https://www.thegrandwhiskyauction.com/past-auctions/cask/180-per-page"
b <- ChromoteSession$new()
b$view()  # abre uma aba real do Chrome controlada pelo chromote
b$Page$navigate(url)
# espera uns segundos para o Cloudflare liberar (ou ajuste conforme sua internet)
Sys.sleep(10)
# pega o documento raiz depois que a página terminou de carregar
doc <- b$DOM$getDocument()
# extrai o HTML real
html <- b$DOM$getOuterHTML(nodeId = doc$root$nodeId)$outerHTML %>%
read_html()
# Import necessary libraries
suppressWarnings({
suppressPackageStartupMessages({
library(dplyr)
library(rvest)
library(stringr)
library(glue)
library(chromote)
})
})
# Language: us-english
Sys.setlocale("LC_ALL", "en_US.UTF-8")
setwd('C:\\Users\\joaov\\Documents\\Whisky Casks ETL')
# Defines the The Grand whisky Auctions URL
url <- "https://www.thegrandwhiskyauction.com/past-auctions/cask/180-per-page"
b <- ChromoteSession$new()
b$Page$navigate(url)
# espera uns segundos para o Cloudflare liberar (ou ajuste conforme sua internet)
Sys.sleep(10)
# pega o documento raiz depois que a página terminou de carregar
doc <- b$DOM$getDocument()
# extrai o HTML real
html <- b$DOM$getOuterHTML(nodeId = doc$root$nodeId)$outerHTML %>%
read_html()
html
# install.packages("chromote")
library(chromote)
url <- "https://thegrandwhiskyauction.com/past-auctions/cask/180-per-page/end-time"
b <- ChromoteSession$new()          # por padrão abre um Chrome controlado
b$Page$navigate(url)
# esperar até o Cloudflare liberar: checagem simples no título ou no conteúdo
start <- Sys.time()
repeat {
Sys.sleep(2)
# pega o título da página
title_eval <- b$Runtime$evaluate("document.title")$result$value
if (!is.null(title_eval) && !grepl("Verifying|verifying|Checking", title_eval, ignore.case=TRUE)) break
if (as.numeric(difftime(Sys.time(), start, units="secs")) > 60) break  # timeout 60s
}
# então extrai o HTML
doc <- b$DOM$getDocument()
html <- b$DOM$getOuterHTML(nodeId = doc$root$nodeId)$outer
html
html %>%
# Extract the script element containing auction data using XPath 'auction_data ='
html_element(xpath = "//script[contains(text(),'auction_data = ')]")
library(chromote)
url <- "https://thegrandwhiskyauction.com/past-auctions/cask/180-per-page/end-time"
b <- ChromoteSession$new()          # por padrão abre um Chrome controlado
b$Page$navigate(url)
# esperar até o Cloudflare liberar: checagem simples no título ou no conteúdo
start <- Sys.time()
repeat {
Sys.sleep(20)
# pega o título da página
title_eval <- b$Runtime$evaluate("document.title")$result$value
if (!is.null(title_eval) && !grepl("Verifying|verifying|Checking", title_eval, ignore.case=TRUE)) break
if (as.numeric(difftime(Sys.time(), start, units="secs")) > 60) break  # timeout 60s
}
# então extrai o HTML
doc <- b$DOM$getDocument()
html <- b$DOM$getOuterHTML(nodeId = doc$root$nodeId)$outer
html
# Loads the rvest, stringr and dplyr libraries
suppressWarnings({
suppressPackageStartupMessages({
library(rvest)
library(stringr)
library(dplyr)
library(glue)
library(lubridate)
library(httr)
library(jsonlite)
})
})
Sys.setlocale(category = "LC_TIME", locale = "en_US.UTF-8")
setwd("C:\\Users\\joaov\\Documents\\Whisky Casks ETL\\silver")
# Whisky Auctioneer
df_whisky_auctioneer <- read.csv2("whisky_auctioneer.csv", sep=',')
sort(colnames(df_whisky_auctioneer))
df_whisky_auctioneer <- df_whisky_auctioneer %>%
mutate(
age = as.character(age)
)
# The Grand Whisky Auction
df_the_grand <- read.csv2("the_grand_whisky_auction.csv", sep=',')
sort(colnames(df_the_grand))
# Just Whisky Auctions
df_just_whisky <- read.csv2("just_whisky_auctions.csv", sep=',', )
sort(colnames(df_just_whisky))
# Prestige Whisky Auction
df_prestige_whisky <- read.csv2("prestige_whisky_auction.csv", sep=',')
sort(colnames(df_prestige_whisky))
# Whisky Online Auctions
df_whisky_online <- read.csv2("whisky_online_auctions.csv", sep=',')
sort(colnames(df_whisky_online))
# Whisky Hammer
df_whisky_hammer <- read.csv2("whisky_hammer.csv", sep=',')
sort(colnames(df_whisky_hammer))
# Join
df <- bind_rows(df_whisky_auctioneer, df_the_grand, df_just_whisky, df_prestige_whisky, df_whisky_online, df_whisky_hammer)
sort(colnames(df))
# Monthly volume
df_months_years <- data.frame(
data = seq.Date(
from = min(as.Date(df$auction_date) %m-% months(12)),
to   = max(as.Date(df$auction_date)),
by   = "month"
)
) %>%
mutate(
year = year(data),
month = month(data)
) %>%
select(year, month)
df <- df %>%
mutate(
month = month(auction_date),
year = year(auction_date)
)
df_monthly_volume <- df %>% group_by(year, month) %>% count()
df_monthly_volume <- df_monthly_volume %>%
right_join(df_months_years) %>%
rename(
volume = n
) %>%
mutate(
volume = if_else(is.na(volume), 0, volume)
)
df_monthly_volume <- df_monthly_volume %>%
arrange(year, month) %>%
mutate(
volume = as.numeric(volume),
)
df_monthly_volume$volume_12m = NA
for (i in seq(12:nrow(df_monthly_volume))){
i_12 = i + 12
df_monthly_volume[i_12, 'volume_12m'] = df_monthly_volume[(i):(i_12-1), 'volume'] %>% sum()
}
for (i in seq(6:(nrow(df_monthly_volume)-1))){
i_6 = i + 6
df_monthly_volume[i_6, 'volume_6m'] = df_monthly_volume[(i):(i_6-1), 'volume'] %>% sum()
}
for (i in seq(3:(nrow(df_monthly_volume)-1))){
i_3 = i + 3
df_monthly_volume[i_3, 'volume_3m'] = df_monthly_volume[(i):(i_3-1), 'volume'] %>% sum()
}
df_monthly_volume <- df_monthly_volume %>%
select(-volume)
# Inflation adjustment
most_recent_date <- df %>%
summarise(max_date = max(auction_date)) %>%
pull(max_date) %>%
as.character() %>%
substr(1, 10) %>%
gsub("-", "/", .)
list_of_dates <- df$auction_date
list_of_values <- df$hammer_price
dates_as_strings <- list_of_dates %>%
as.character() %>%
substr(1, 10) %>%
gsub("-", "/", .)
payload <- list(
dates = dates_as_strings,
values = as.list(list_of_values),
currency = "GBP",
present_date = most_recent_date
)
headers <- add_headers(
"Content-Type" = "application/json"
)
response <- POST(
url = "https://financial-utilities-api.onrender.com/inflation_adjustment",
body = payload,
encode = "json",
headers
)
if (status_code(response) != 200) {
Sys.sleep(60)
response <- POST(
url = "https://financial-utilities-api.onrender.com/inflation_adjustment",
body = payload,
encode = "json",
headers
)
if (status_code(response) != 200) {
Sys.sleep(60)
response <- POST(
url = "https://financial-utilities-api.onrender.com/inflation_adjustment",
body = payload,
encode = "json",
headers
)
if (status_code(response) != 200) {
stop(
paste(
"API error",
status_code(response),
content(response, "text", encoding = "UTF-8")
)
)
}
}
}
df_inflation_adjusted_values <- content(
response,
as = "parsed",
simplifyVector = FALSE
)
df_inflation_adjusted_values <- data.frame(
date = as.character(as.Date(unlist(df_inflation_adjusted_values$Date))),
original_value = as.numeric(unlist(df_inflation_adjusted_values$Value)),
inflation_adjusted_hammer_price = as.numeric(unlist(df_inflation_adjusted_values[["Adjusted Value"]])),
acumulated_inflation_rate = as.numeric(unlist(df_inflation_adjusted_values[["Accumulated Inflation (%)"]]))
)
df$inf_adj_hammer_price <- df_inflation_adjusted_values$inflation_adjusted_hammer_price
# New variables
df <- df %>%
mutate(
inf_adj_hammer_price = as.numeric(inf_adj_hammer_price),
age = as.numeric(age),
rla = as.numeric(rla),
bottles_at_cask_strength = as.numeric(bottles_at_cask_strength),
inf_adj_hammer_price_per_litre_of_alcohol_times_age = inf_adj_hammer_price * age / rla,
inf_adj_hammer_price_per_bottle_at_cask_strength = round(inf_adj_hammer_price / bottles_at_cask_strength, 2),
inf_adj_hammer_price_per_litre_of_alcohol = round(inf_adj_hammer_price / rla, 2),
)
df <- df %>% left_join(df_monthly_volume)
# Save full database
setwd("C:\\Users\\joaov\\Documents\\Whisky Casks ETL\\gold")
write.csv(df, file = "casks_database.csv", row.names = FALSE, fileEncoding = "UTF-8")
# Rows selection
df <- df %>%
filter(
!is.na(age) & !is.na(previous_spirit) & !is.na(rla)
)
# Select columns
df <- df %>%
select(
auction_date, distillery, region, country, strength, rla, bulk_litres, distillery_status,
cask_type, cask_filling, previous_spirit, age, bottles_at_cask_strength, volume_12m, volume_6m, volume_3m, inf_adj_hammer_price,
inf_adj_hammer_price_per_bottle_at_cask_strength, inf_adj_hammer_price_per_litre_of_alcohol,
inf_adj_hammer_price_per_litre_of_alcohol_times_age
)
# Save database for casks valuation ML model
write.csv(df, file = "casks_database__casks_valuation.csv", row.names = FALSE, fileEncoding = "UTF-8")
